# AA66 Protocol (Unencrypted)

**Protocol Mode**: 3
**App**: AirHeaterBLE
**Packet Length**: 20 bytes

## Overview

The AA66 protocol is a variant used by BYD and some Vevor heaters. It has a slightly different byte layout compared to AA55.

## BLE Configuration

| Type | UUID |
|------|------|
| Service | `0000FFE0-0000-1000-8000-00805F9B34FB` |
| Write Char | `0000FFE1-0000-1000-8000-00805F9B34FB` |
| Notify Char | `0000FFE1-0000-1000-8000-00805F9B34FB` |

## Response Packet Structure

```
Offset  Bytes  Field            Description
------  -----  -----            -----------
0-1     2      Header           AA 66 (fixed)
2       1      Reserved
3       1      Running State    0=off, 1=on
4       1      Error Code
5       1      Running Step
6       1      Altitude         Single byte (0-255)
7       1      Reserved
8       1      Running Mode     1=level, 2=temp
9       1      Set Value        Temp or Level depending on mode
10      1      Reserved
11-12   2      Voltage          Little-endian, /10 for volts
13-14   2      Case Temp        Little-endian, auto-scale
15      1      Cab Temp         Single byte
16-19   4      Reserved/Checksum
```

## Parsing Logic

```python
def parse(data: bytearray) -> dict:
    parsed = {}

    parsed["running_state"] = data[3]
    parsed["error_code"] = data[4]
    parsed["running_step"] = data[5]
    parsed["altitude"] = data[6]  # Single byte
    parsed["running_mode"] = data[8]

    if parsed["running_mode"] == 1:  # Level mode
        parsed["set_level"] = max(1, min(10, data[9]))
    elif parsed["running_mode"] == 2:  # Temp mode
        parsed["set_temp"] = max(8, min(36, data[9]))

    # Voltage: little-endian /10
    voltage_raw = data[11] | (data[12] << 8)
    parsed["supply_voltage"] = voltage_raw / 10.0

    # Case temp: auto-detect scale (>350 = 0.1Â°C scale)
    case_temp_raw = data[13] | (data[14] << 8)
    if case_temp_raw > 350:
        parsed["case_temperature"] = case_temp_raw / 10.0
    else:
        parsed["case_temperature"] = float(case_temp_raw)

    parsed["cab_temperature"] = data[15]

    return parsed
```

## Command Format

Uses standard 8-byte AA55 command format (same as AA55 protocol).

## Key Differences from AA55

| Feature | AA55 | AA66 |
|---------|------|------|
| Header | AA 55 | AA 66 |
| Altitude | 2 bytes LE | 1 byte |
| Case temp | Always degrees | Auto-scale |
| Cab temp | 2 bytes signed | 1 byte |
| Packet length | 18-20 | 20 |

## Detection

Detected when:
1. Header is AA66
2. Packet length is approximately 20 bytes
