# AA55 Protocol (Unencrypted)

**Protocol Mode**: 1
**App**: AirHeaterBLE
**Packet Length**: 18-20 bytes

## Overview

The AA55 protocol is the original unencrypted protocol used by Vevor diesel heaters. It provides basic heater control and monitoring via BLE notifications.

## BLE Configuration

| Type | UUID |
|------|------|
| Service | `0000FFE0-0000-1000-8000-00805F9B34FB` |
| Write Char | `0000FFE1-0000-1000-8000-00805F9B34FB` |
| Notify Char | `0000FFE1-0000-1000-8000-00805F9B34FB` |

## Response Packet Structure

```
Offset  Bytes  Field            Description
------  -----  -----            -----------
0-1     2      Header           AA 55 (fixed)
2       1      Reserved         Usually 0
3       1      Running State    0=off, 1=on
4       1      Error Code       0=no error
5       1      Running Step     Current operation step
6-7     2      Altitude         Little-endian, meters
8       1      Running Mode     1=level, 2=temp, 3=manual
9       1      Set Value        Temp (mode=2) or Level (mode=1)
10      1      Set Level        Level when mode=2
11-12   2      Voltage          Little-endian, /10 for volts
13-14   2      Case Temp        Little-endian, signed
15-16   2      Cab Temp         Little-endian, signed
17      1      Checksum         Optional
```

## Parsing Logic

```python
def parse(data: bytearray) -> dict:
    parsed = {}

    parsed["running_state"] = data[3]
    parsed["error_code"] = data[4]
    parsed["running_step"] = data[5]
    parsed["altitude"] = data[6] + 256 * data[7]
    parsed["running_mode"] = data[8]

    if parsed["running_mode"] == 1:  # Level mode
        parsed["set_level"] = data[9]
    elif parsed["running_mode"] == 2:  # Temp mode
        parsed["set_temp"] = data[9]
        parsed["set_level"] = data[10] + 1
    elif parsed["running_mode"] == 3:  # Manual
        parsed["set_level"] = data[10] + 1

    parsed["supply_voltage"] = (256 * data[12] + data[11]) / 10
    parsed["case_temperature"] = signed_int16(256 * data[14] + data[13])
    parsed["cab_temperature"] = signed_int16(256 * data[16] + data[15])

    return parsed
```

## Command Format

8-byte packet:
```
Byte 0: 0xAA
Byte 1: 0x55
Byte 2: Passkey // 100
Byte 3: Passkey % 100
Byte 4: Command code
Byte 5: Argument low byte
Byte 6: Argument high byte
Byte 7: Checksum (bytes 2-6 sum mod 256)
```

## Example Packets

### Status Response (18 bytes)
```
AA 55 00 01 00 05 E8 03 02 19 03 7C 00 3C 00 14 00 XX
     │  │  │  │  └────┘  │  │  │  └───┘  └───┘  └───┘
     │  │  │  │    │     │  │  │    │      │      │
     │  │  │  │  altitude│  │  │  voltage case  cab
     │  │  │  step=5     │  │  │  12.4V   60°C  20°C
     │  │  error=0      mode │  level=3
     │  state=1 (on)     =2  temp=25
     reserved
```

### Power On Command
```
AA 55 0C 22 03 01 00 32
     │  │  │  │  │  └─ checksum
     │  │  │  │  └─ arg high
     │  │  │  └─ arg low (1=on)
     │  │  └─ cmd=3 (power)
     │  └─ passkey low (34)
     └─ passkey high (12) → passkey=1234
```

## Running States

| Value | State |
|-------|-------|
| 0 | Off / Standby |
| 1 | Running / Heating |

## Running Modes

| Value | Mode |
|-------|------|
| 1 | Level (gear) mode |
| 2 | Temperature mode |
| 3 | Manual mode |

## Error Codes

| Code | Error |
|------|-------|
| 0 | No error |
| 1 | E01 - Ignition failure |
| 2 | E02 - Flame out |
| 3 | E03 - Overheat |
| 4 | E04 - Fan failure |
| 5 | E05 - Pump failure |
| 6 | E06 - Sensor failure |
| 7 | E07 - Low voltage |
| 8 | E08 - High voltage |
